{{- if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash

set -eo pipefail

export HOMEBREW_BUNDLE_FILE="${HOME}/.config/homebrew/Brewfile"
brew bundle --verbose

# ─── License keys ────────────────────────────────────────────────────────────
defaults write com.incrediblebee.Archiver LicenseKey \
  -string {{ onepasswordRead "op://Private/Archiver 5/license key" | quote }}

defaults write com.surteesstudios.Bartender license6 \
  -string {{ onepasswordRead "op://Private/Bartender 6/license key" | quote }}
defaults write com.surteesstudios.Bartender license6HoldersName \
  -string {{ onepasswordRead "op://Private/Bartender 6/license holder" | quote }}

defaults write com.rogueamoeba.soundsource registrationInfo -dict \
  Name  -string {{ onepasswordRead "op://Private/Sound Source/Name" | quote }} \
  Code  -string {{ onepasswordRead "op://Private/Sound Source/license key" | quote }}

# ─── App preferences ─────────────────────────────────────────────────────────

# Bartender
defaults write com.surteesstudios.Bartender launchAtLogin.isEnabled  -int 1
defaults write com.surteesstudios.Bartender SUEnableAutomaticChecks   -int 1
defaults write com.surteesstudios.Bartender TemporaryMenuBarItemShowTime -int 5
defaults write com.surteesstudios.Bartender DisableAllTriggers        -int 0
defaults write com.surteesstudios.Bartender pausingEnabled            -int 0
defaults write com.surteesstudios.Bartender supressDuringMoves        -int 1

# SoundSource
defaults write com.rogueamoeba.soundsource menuBarIcon       -string "speaker"
defaults write com.rogueamoeba.soundsource keyboardVolume    -int 1
defaults write com.rogueamoeba.soundsource settingsPane      -string "appearance"
defaults write com.rogueamoeba.soundsource applicationTheme  -int 2

# BetterTouchTool
defaults write com.hegenberg.BetterTouchTool BTTSyncCloudProvider -int 2
defaults write com.hegenberg.BetterTouchTool SUAutomaticallyUpdate -int 1
defaults write com.hegenberg.BetterTouchTool launchOnStartup       -int 1

# Dock
dockutil --position 1 --add "/System/Applications/Messages.app"
dockutil --position 2 --add "/Applications/Firefox.app"
dockutil --position 3 --add "/Applications/iTerm.app"
dockutil --position 4 --add "/Applications/Sublime Text.app"
dockutil --position 5 --add "/System/Applications/System Settings.app"

killall "Archiver"        || true
killall "SoundSource"     || true
killall "Bartender 6"     || true
killall "BetterTouchTool" || true
killall "Dock"            || true
killall "Finder"          || true
{{- end -}}
