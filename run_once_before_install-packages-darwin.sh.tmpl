{{- if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash

set -eo pipefail

export HOMEBREW_BUNDLE_FILE="${HOME}/.config/homebrew/Brewfile"
brew bundle --verbose

# ─── License keys ────────────────────────────────────────────────────────────
defaults write com.incrediblebee.Archiver LicenseKey \
    -string {{ onepasswordRead "op://Private/Archiver 5/license key" | quote }}

defaults write com.surteesstudios.Bartender license6 \
  -string {{ onepasswordRead "op://Private/Bartender 6/license key" | quote }}
defaults write com.surteesstudios.Bartender license6HoldersName \
    -string {{ onepasswordRead "op://Private/Bartender 6/license holder" | quote }}

defaults write com.rogueamoeba.soundsource registrationInfo -dict \
    Name  -string {{ onepasswordRead "op://Private/Sound Source/Name" | quote }} \
    Code  -string {{ onepasswordRead "op://Private/Sound Source/license key" | quote }}

# ─── App preferences ─────────────────────────────────────────────────────────

# Bartender
defaults write com.surteesstudios.Bartender launchAtLogin.isEnabled  -int 1
defaults write com.surteesstudios.Bartender SUEnableAutomaticChecks   -int 1
defaults write com.surteesstudios.Bartender TemporaryMenuBarItemShowTime -int 5
defaults write com.surteesstudios.Bartender DisableAllTriggers        -int 0
defaults write com.surteesstudios.Bartender pausingEnabled            -int 0
defaults write com.surteesstudios.Bartender supressDuringMoves        -int 1

# SoundSource
defaults write com.rogueamoeba.soundsource menuBarIcon       -string "speaker"
defaults write com.rogueamoeba.soundsource keyboardVolume    -int 1
defaults write com.rogueamoeba.soundsource settingsPane      -string "appearance"
defaults write com.rogueamoeba.soundsource applicationTheme  -int 2

# iStat Menus 7
defaults write com.bjango.istatmenus.menubar.7 License -dict \
    License -string {{ onepasswordRead "op://Private/iStat Menus/license key" | quote }}
defaults write com.bjango.istatmenus.menubar.7 MenubarCurrentApperance -string "Dark"
defaults write com.bjango.istatmenus.menubar.7 Menu -dict \
    Theme -dict Dark -string "dark"
defaults write com.bjango.istatmenus.menubar.7 Menubar -dict \
    CustomColor -dict Dark -string "0 0.8499822616577148 1 1" \
    Theme -dict Dark -string "custom"
defaults write com.bjango.istatmenus.menubar.7 Combined -dict \
    Menubar -dict Items -array
defaults write com.bjango.istatmenus.menubar.7 Profiles -dict \
    Available -dict identifier -string "default" \
    Settings -dict default -dict \
        Battery -dict Menubar -dict \
            DetailedState -integer 0 \
            Enabled -integer 1 \
            Items -dict Standard -array \
                -dict source -integer 8 subtype -integer 11 type -integer 4 \
        CPU -dict Menubar -dict Enabled -integer 0 \
        Combined -dict Menubar -dict \
            Enabled -integer 0 \
            Items -array -dict source -integer 21 \
        Disks -dict Menubar -dict Enabled -integer 0 \
        Memory -dict Menubar -dict Enabled -integer 0 \
        Network -dict Menubar -dict Enabled -integer 0 \
        Sensors -dict Menubar -dict \
            Enabled -integer 0 \
            Sensors -array
defaults write com.bjango.istatmenus.menubar.7 Sensors -dict \
    Global -dict \
        Degrees -dict Format -integer 1 \
        DetailLevel -integer 0 \
        Fans -dict \
            Curves -dict all -dict curve -array \
                -dict speed -integer 0 temperature -integer 0 \
                -dict speed -integer 0 temperature -string "0.45" \
                -dict speed -integer 1 temperature -string "0.95" \
                -dict speed -integer 1 temperature -integer 1

# BetterTouchTool
defaults write com.hegenberg.BetterTouchTool BTTSyncCloudProvider -int 2
defaults write com.hegenberg.BetterTouchTool SUAutomaticallyUpdate -int 1
defaults write com.hegenberg.BetterTouchTool launchOnStartup       -int 1

# Dock
dockutil --position 1 --add "/System/Applications/Messages.app"        || true
dockutil --position 2 --add "/Applications/Firefox.app"                || true
dockutil --position 3 --add "/Applications/iTerm.app"                  || true
dockutil --position 4 --add "/Applications/Sublime Text.app"           || true
dockutil --position 5 --add "/System/Applications/System Settings.app" || true

killall "Archiver"        || true
killall "SoundSource"     || true
killall "Bartender 6"     || true
killall "BetterTouchTool" || true
killall "iStat Menus"     || true
killall "Dock"            || true
killall "Finder"          || true
{{- end -}}
